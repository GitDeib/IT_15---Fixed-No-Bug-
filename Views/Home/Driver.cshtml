@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Driver")]
@model DriverDashboardViewModel
@using IT15_Project.Models;


<!-- Mapbox -->
<link href="https://api.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js"></script>

<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.min.js"></script>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" rel="stylesheet" />

<div class="container-fluid">
    <div class="row min-vh-100">
        <!-- Left Column: Driver Info + Rating -->
        <div class="col-md-3 bg-light p-4">
            <h4 class="mb-3">Driver Details</h4>
            <!-- Profile Picture -->
            <img src="~/uploads/drivers/@Model.Driver.ApplicationUser.ProfilePhotoPath"  class="rounded-circle" width="100" height="100">
            <p><strong>Name:</strong> @Model.Driver.ApplicationUser.FullName</p> <!-- Updated to use UserName -->
            <p>
                <strong>Status:</strong>
                @if (Model.Driver.Status == "Verified")
                {
                    <span class="badge bg-success">Verified</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark">Not Verified</span>
                }

            </p>
            <p><strong>License No.:</strong> D12345678</p>
            <p><strong>Vehicle:</strong> Toyota Vios</p>
            <p><strong>Plate:</strong> ABC-1234</p>

            <hr>

            <!-- Rating Section -->
            <h4 class="mt-4">Rating</h4>
            <div class="mb-4">
                <!-- Example of dynamic rating -->
                @for (int i = 0; i < 5; i++)
                {
                    <span class="text-warning">&#9733;</span>
                }
                <p class="mt-2">
                    @(Model.CurrentRide?.RatingsReviews?.Any() == true ?
                        Model.CurrentRide.RatingsReviews.Average(r => r.Rating).ToString("F1") :
                        "No Rating")
                    out of 5
                </p>
            </div>
            <hr>

            <!-- Payout Request Section -->
            <h4 class="mt-4">Payout Request</h4>
            <div class="mb-3">
                <p><strong>Base Fare:</strong> ₱@Model.FareSetting?.BaseFare ?? 0</p> <!-- Updated to handle null values -->
                <p><strong>Per Kilometer Rate:</strong> ₱@Model.FareSetting?.PerKilometerRate ?? 0</p>
                <p><strong>Per Minute Rate:</strong> ₱@Model.FareSetting?.PerMinuteRate ?? 0</p>

                <button class="btn btn-outline-primary btn-sm">Request Payout</button>
            </div>

        </div>

        <!-- Center Column: Wallet & Current Ride -->
        <div class="col-md-6 p-4 text-center">
            <div class="card text-black bg-white glass-panel p-3 d-flex flex-column justify-content-between mb-4">
                <h5 class="card-title">Driver's Available Balance</h5>
                <div class="d-flex align-items-center justify-content-center">
                    <img src="~/lib/GIF/profit.gif" alt="KM" style="width: 50px; height: 50px;">
                    <p class="fs-3 mb-0 me-2" style="font-family: 'Quicksand', sans-serif; font-weight: 700;">₱@Model.CurrentRide?.EstimatedFare ?? 0</p> <!-- Updated to handle null values -->
                </div>
            </div>

            <!-- Map Placeholder -->
            <div id="map" class="mb-4" style="height: 300px; width: 100%; border: 2px solid #ccc; border-radius: 10px;">
                <!-- Map will be rendered here by JS -->
            </div>

            <button class="btn btn-outline-dark" onclick="toggleInstructions()">Show Direction</button>

            <script>
                function toggleInstructions() {
                    const el = document.querySelector('.mapbox-directions-instructions');
                    if (el) {
                        el.style.display = el.style.display === 'none' ? 'block' : 'none';
                    }
                }
            </script>

            <hr>
            <!-- Current Ride Info -->
            <div class="card bg-light p-3 mb-2">
                <h5 class="card-title">Current Ride</h5>

                @if (Model.AcceptedRide != null)
                {
                    <p><strong>Passenger:</strong> @Model.AcceptedRide.User?.FullName</p>
                    <p><strong>Pickup:</strong> @Model.AcceptedRide.PickupLocation</p>
                    <p><strong>Destination:</strong> @Model.AcceptedRide.DropoffLocation</p>
                    <p><strong>Vehicle Type:</strong> @Model.AcceptedRide.VehicleType</p>
                    <p><strong>Estimated Fare:</strong> ₱@Model.AcceptedRide.EstimatedFare.ToString("F2")</p>

                    <div class="d-flex justify-content-center gap-2 mt-2">
                        <form asp-action="CompleteRide" method="post">
                            <input type="hidden" name="bookingId" value="@Model.AcceptedRide.Id" />
                            <button type="submit" class="btn btn-success btn-sm">Picked Up</button>
                        </form>
                        <form asp-action="CancelRide" method="post">
                            <input type="hidden" name="bookingId" value="@Model.AcceptedRide.Id" />
                            <button type="submit" class="btn btn-danger btn-sm">Cancel</button>
                        </form>
                    </div>
                }
                else if (Model.StartedRide != null)
                {
                    <p><strong>Passenger:</strong> @Model.StartedRide.User?.FullName</p>
                    <p><strong>Pickup:</strong> @Model.StartedRide.PickupLocation</p>
                    <p><strong>Destination:</strong> @Model.StartedRide.DropoffLocation</p>
                    <p><strong>Vehicle Type:</strong> @Model.StartedRide.VehicleType</p>
                    <p><strong>Estimated Fare:</strong> ₱@Model.StartedRide.EstimatedFare.ToString("F2")</p>

                    <div class="d-flex justify-content-center gap-2 mt-2">
                        <form asp-action="MarkComplete" method="post">
                            <input type="hidden" name="bookingId" value="@Model.StartedRide.Id" />
                            <button type="submit" class="btn btn-primary btn-sm">Complete Ride</button>
                        </form>
                    </div>
                }
                else
                {
                    <p class="text-muted">No active ride at the moment.</p>
                }
            </div>


 
        </div>

        <!-- Right Column: Available Passengers -->
        <div class="col-md-3 bg-light p-4">
            <h4 class="mb-3">Available Passengers</h4>
            @if (Model.Driver.Status != "Verified")
            {
                <div class="alert alert-warning">
                    You must be verified to accept bookings.
                </div>
            }
            <div class="list-group">
                @foreach (var passenger in Model.AvailablePassengers)
                {
                    <div class="list-group-item glass-panel mb-3">
                        <p><strong>Passenger:</strong> @passenger.User?.FullName</p>
                        <p><small>Pickup: @passenger.PickupLocation</small></p>
                        <p><small>Destination: @passenger.DropoffLocation</small></p>
                        <p><small>Seats: @passenger.VehicleSeat | Time: @passenger.RequestedAt.ToString("hh:mm tt")</small></p>

                        @if (Model.Driver.Status == "Verified")
                        {
                            <form asp-action="AcceptBooking" asp-controller="Home" method="post">
                                <input type="hidden" name="bookingId" value="@passenger.Id" />
                                <button type="submit" class="btn btn-sm btn-success">Accept</button>
                            </form>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-secondary" disabled>Accept (Verify First)</button>
                        }
                    </div>
                }

            </div>
        </div>
    </div>
</div>

<script src="~/js/DriverMap.js"></script>